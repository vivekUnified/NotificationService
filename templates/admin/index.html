{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Reset and Layout */
    .dashboard-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        width: 100%;
        align-items: flex-start;
    }

    /* Left Sidebar: Removed (Using built-in nav sidebar) */

    /* Center: Charts */
    .center-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .chart-box {
        background: white;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        min-height: 300px;
        /* Ensure height for Chart.js */
        position: relative;
        /* Chart.js needs relative parent usually */
    }

    .dark-mode .chart-box {
        background: #333;
    }

    /* Right Sidebar: Recent Actions */
    .right-sidebar {
        flex: 0 0 280px;
    }

    /* Adjust App List for Sidebar */
    .left-sidebar .module {
        margin-bottom: 10px;
    }

    .left-sidebar table {
        width: 100%;
    }

    /* Responsive */
    @media (max-width: 1000px) {
        .dashboard-container {
            flex-direction: column;
        }

        .left-sidebar,
        .right-sidebar {
            flex: 1;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- CENTER: Charts -->
    <div class="center-content">
        <div class="chart-box">
            <h3>Notification Status</h3>
            <div style="height: 250px; width: 100%;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h3>Channel Usage</h3>
            <div style="height: 250px; width: 100%;">
                <canvas id="channelChart"></canvas>
            </div>
        </div>
    </div>
    <!-- RIGHT: Recent Actions -->
    <div class="right-sidebar">
        <div>
            <div class="module" id="recent-actions-module">
                <h2>{% translate 'Recent actions' %}</h2>
                <h3>{% translate 'My actions' %}</h3>
                {% load log %}
                {% get_admin_log 10 as admin_log for_user user %}
                {% if not admin_log %}
                <p>{% translate 'None available' %}</p>
                {% else %}
                <ul class="actionlist">
                    {% for entry in admin_log %}
                    <li
                        class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %}changelink{% endif %}{% if entry.is_deletion %}deletelink{% endif %}">
                        {% if entry.is_deletion or not entry.get_admin_url %}
                        {{ entry.object_repr }}
                        {% else %}
                        <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                        {% endif %}
                        <br>
                        {% if entry.content_type %}
                        <span class="mini quiet">{{ entry.content_type.name|capfirst }}</span>
                        {% else %}
                        <span class="mini quiet">{% translate 'Unknown content' %}</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Fetching stats...");
        fetch('/admin/dashboard/stats/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Stats received:", data);

                // Status Chart
                const statusCanvas = document.getElementById('statusChart');
                if (statusCanvas) {
                    new Chart(statusCanvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data.status_counts),
                            datasets: [{
                                data: Object.values(data.status_counts),
                                backgroundColor: ['#4caf50', '#f44336', '#ff9800', '#2196f3']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                // Channel Chart
                const channelCanvas = document.getElementById('channelChart');
                if (channelCanvas) {
                    new Chart(channelCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data.channel_counts),
                            datasets: [{
                                label: 'Notifications per Channel',
                                data: Object.values(data.channel_counts),
                                backgroundColor: '#36f'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error fetching stats:', error));
    });
</script>
{% endblock %}